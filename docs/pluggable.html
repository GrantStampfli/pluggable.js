<!DOCTYPE html>

<html>
<head>
  <title>pluggable.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>pluggable.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*
       ____  __                        __    __         _
      / __ \/ /_  __ ___   ___  ____ _/ /_  / /__      (_)____
     / /_/ / / / / / __ \/ __ \/ __/ / __ \/ / _ \    / / ___/
    / ____/ / /_/ / /_/ / /_/ / /_/ / /_/ / /  __/   / (__  )
   /_/   /_/\__,_/\__, /\__, /\__/_/_.___/_/\___(_)_/ /____/
                 /____//____/                    /___/
 */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Pluggable.js enables you to make your Javascript code pluggable while still
keeping sensitive objects and data private through closures.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">root, factory</span>) </span>{
    define(<span class="hljs-string">"pluggable"</span>, [<span class="hljs-string">"jquery"</span>, <span class="hljs-string">"underscore"</span>], factory);
}(<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$, _</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Pluggable</span> (<span class="hljs-params">plugged</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>The Pluggable class encapsulates the plugin architecture, and gets
created whenver <code>pluggable.enable(obj);</code> on the object they want
to make pluggable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.plugged = plugged;
        <span class="hljs-keyword">this</span>.plugged._super = {};
        <span class="hljs-keyword">this</span>.plugins = {};
        <span class="hljs-keyword">this</span>.initialized_plugins = [];
    }

    _.extend(Pluggable.prototype, {</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Now we add methods to the Pluggable class by adding them to its
prototype.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        wrappedOverride: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key, value, super_method</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>We create a partially applied wrapper function, that
makes sure to set the proper super method when the
overriding method is called. This is done to enable
chaining of plugin methods, all the way up to the
original method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> super_method === <span class="hljs-string">"function"</span>) {
                <span class="hljs-keyword">this</span>._super[key] = super_method.bind(<span class="hljs-keyword">this</span>);
            }
            <span class="hljs-keyword">return</span> value.apply(<span class="hljs-keyword">this</span>, _.rest(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">3</span>));
        },

        _overrideAttribute: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key, plugin</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Overrides an attribute on the original object (the thing being
plugged into).</p>
<p>If the attribute being overridden is a function, then the original
function will still be available via the _super attribute.</p>
<p>If the same function is being overridden multiple times, then
the original function will be available at the end of a chain of
functions, starting from the most recent override, all the way
back to the original function, each being referenced by the
previous’ _super attribute.</p>
<p>For example:</p>
<p><code>plugin2.MyFunc._super.myFunc =&gt; plugin1.MyFunc._super.myFunc =&gt; original.myFunc</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> value = plugin.overrides[key];
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"function"</span>) {
                <span class="hljs-keyword">var</span> wrapped_function = _.partial(
                    <span class="hljs-keyword">this</span>.wrappedOverride, key, value, <span class="hljs-keyword">this</span>.plugged[key]
                );
                <span class="hljs-keyword">this</span>.plugged[key] = wrapped_function;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">this</span>.plugged[key] = value;
            }
        },

        _extendObject: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">obj, attributes</span>) </span>{
            <span class="hljs-keyword">if</span> (!obj.prototype._super) {
                <span class="hljs-comment">/* <span class="hljs-doctag">FIXME:</span> make generic */</span>
                obj.prototype._super = {<span class="hljs-string">'converse'</span>: <span class="hljs-keyword">this</span>.plugged };
            }
            _.each(attributes, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value, key</span>) </span>{
                <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'events'</span>) {
                    obj.prototype[key] = _.extend(value, obj.prototype[key]);
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'function'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>We create a partially applied wrapper function, that
makes sure to set the proper super method when the
overriding method is called. This is done to enable
chaining of plugin methods, all the way up to the
original method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">var</span> wrapped_function = _.partial(
                        <span class="hljs-keyword">this</span>.wrappedOverride, key, value, obj.prototype[key]
                    );
                    obj.prototype[key] = wrapped_function;
                } <span class="hljs-keyword">else</span> {
                    obj.prototype[key] = value;
                }
            }.bind(<span class="hljs-keyword">this</span>));
        },

        loadOptionalDependencies: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">plugin</span>) </span>{
            _.each(plugin.optional_dependencies, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">name</span>) </span>{
                <span class="hljs-keyword">var</span> dep = <span class="hljs-keyword">this</span>.plugins[name];
                <span class="hljs-keyword">if</span> (dep) {
                    <span class="hljs-keyword">if</span> (_.contains(dep.optional_dependencies, plugin.__name__)) {
                        <span class="hljs-comment">/* <span class="hljs-doctag">FIXME:</span> circular dependency checking is only one level deep. */</span>
                        <span class="hljs-keyword">throw</span> <span class="hljs-string">"Found a circular dependency between the plugins \""</span>+
                              plugin.__name__+<span class="hljs-string">"\" and \""</span>+name+<span class="hljs-string">"\""</span>;
                    }
                    <span class="hljs-keyword">this</span>.initializePlugin(dep);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">this</span>.throwUndefinedDependencyError(
                        <span class="hljs-string">"Could not find optional dependency \""</span>+name+<span class="hljs-string">"\" "</span>+
                        <span class="hljs-string">"for the plugin \""</span>+plugin.__name__+<span class="hljs-string">"\". "</span>+
                        <span class="hljs-string">"If it's needed, make sure it's loaded by require.js"</span>);
                }
            }.bind(<span class="hljs-keyword">this</span>));
        },

        throwUndefinedDependencyError: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">msg</span>) </span>{
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.plugged.strict_plugin_dependencies) {
                <span class="hljs-keyword">throw</span> msg;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-built_in">console</span>.log(msg);
                <span class="hljs-keyword">return</span>;
            }
        },

        applyOverrides: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">plugin</span>) </span>{
            _.each(<span class="hljs-built_in">Object</span>.keys(plugin.overrides || {}), <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>We automatically override all methods and Backbone views and
models that are in the “overrides” namespace.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> override = plugin.overrides[key];
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> override === <span class="hljs-string">"object"</span>) {
                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>.plugged[key] === <span class="hljs-string">'undefined'</span>) {
                        <span class="hljs-keyword">this</span>.throwUndefinedDependencyError(<span class="hljs-string">"Error: Plugin \""</span>+plugin.__name__+<span class="hljs-string">"\" tried to override "</span>+key+<span class="hljs-string">" but it's not found."</span>);
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">this</span>._extendObject(<span class="hljs-keyword">this</span>.plugged[key], override);
                    }
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">this</span>._overrideAttribute(key, plugin);
                }
            }.bind(<span class="hljs-keyword">this</span>));
        },

        initializePlugin: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">plugin</span>) </span>{
            <span class="hljs-keyword">if</span> (_.contains(<span class="hljs-keyword">this</span>.initialized_plugins, plugin.__name__)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Don’t initialize plugins twice, otherwise we get
infinite recursion in overridden methods.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">return</span>;
            }
            _.extend(plugin, <span class="hljs-keyword">this</span>.properties);
            <span class="hljs-keyword">if</span> (plugin.optional_dependencies) {
                <span class="hljs-keyword">this</span>.loadOptionalDependencies(plugin);
            }
            <span class="hljs-keyword">this</span>.applyOverrides(plugin);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> plugin.initialize === <span class="hljs-string">"function"</span>) {
                plugin.initialize.bind(plugin)(<span class="hljs-keyword">this</span>);
            }
            <span class="hljs-keyword">this</span>.initialized_plugins.push(plugin.__name__);
        },

        initializePlugins: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">properties</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>The properties variable is an object of attributes and methods
which will be attached to the plugins.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (!_.size(<span class="hljs-keyword">this</span>.plugins)) {
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">this</span>.properties = properties;
            _.each(_.values(<span class="hljs-keyword">this</span>.plugins), <span class="hljs-keyword">this</span>.initializePlugin.bind(<span class="hljs-keyword">this</span>));
        }
    });
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">'enable'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">object</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Call this method to make an object pluggable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span> _.extend(object, {<span class="hljs-string">'pluggable'</span>: <span class="hljs-keyword">new</span> Pluggable(object)});
        }
    };
}));</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
